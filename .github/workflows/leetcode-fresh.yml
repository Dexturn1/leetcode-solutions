name: Fresh LeetCode Organizer

on:
  push:
    branches: [ main ]
  schedule:
    - cron: "0 0 * * *"  # runs daily at midnight UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  organize:
    runs-on: ubuntu-latest

    steps:
      # Step 1 ‚Äî Checkout repository with full history
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # Step 2 ‚Äî Set up Python 3.11.9
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11.9"

      # Step 3 ‚Äî Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests matplotlib pillow

      # Step 4 ‚Äî Run sorter script (ignore errors if no LeetCode problems yet)
      - name: Run sorter script
        run: |
          set -e
          echo "üîÅ Running sort_by_topic.py..."
          python .github/scripts/sort_by_topic.py || echo "‚ö†Ô∏è Sort script completed with warnings but workflow continues."

      # Step 5 ‚Äî Generate LeetCode stats chart
      - name: Generate LeetCode stats chart
        run: |
          python <<'PYCODE'
          import os
          import matplotlib.pyplot as plt

          base = "LeetCode"
          difficulty_colors = {"Easy": "#00C853", "Medium": "#FFD600", "Hard": "#D50000"}
          difficulty_counts = {"Easy": 0, "Medium": 0, "Hard": 0}

          for root, _, files in os.walk(base):
              for f in files:
                  if f.endswith((".java", ".py")):
                      if "Easy" in root:
                          difficulty_counts["Easy"] += 1
                      elif "Medium" in root:
                          difficulty_counts["Medium"] += 1
                      elif "Hard" in root:
                          difficulty_counts["Hard"] += 1

          if sum(difficulty_counts.values()) == 0:
              difficulty_counts = {"Easy": 1, "Medium": 1, "Hard": 1}

          labels = list(difficulty_counts.keys())
          sizes = list(difficulty_counts.values())
          colors = [difficulty_colors[d] for d in labels]

          plt.figure(figsize=(6, 6))
          plt.pie(
              sizes,
              labels=[f"{l} ({v})" for l, v in zip(labels, sizes)],
              colors=colors,
              autopct="%1.1f%%",
              startangle=140,
              wedgeprops={"edgecolor": "white", "linewidth": 2},
          )
          plt.title("LeetCode Difficulty Distribution", fontsize=14, fontweight="bold")
          plt.savefig("LeetCode/stats.png", bbox_inches="tight")
          PYCODE

      # Step 6 ‚Äî Auto-generate README with badges and chart
      - name: Regenerate README.md
        run: |
          total=$(find LeetCode -name '*.java' -o -name '*.py' | wc -l)
          easy=$(grep -r -l "Easy" LeetCode | wc -l || echo 0)
          medium=$(grep -r -l "Medium" LeetCode | wc -l || echo 0)
          hard=$(grep -r -l "Hard" LeetCode | wc -l || echo 0)
          last_updated=$(date '+%d %b %Y, %I:%M %p')
          total_available=2800
          percent=$(( total * 100 / total_available ))
          [ $percent -lt 30 ] && color="red" || ([ $percent -lt 70 ] && color="yellow" || color="brightgreen")
          blocks=$(( percent / 10 ))
          bar=$(printf '‚ñà%.0s' $(seq 1 $blocks))
          emptybar=$(printf '‚ñë%.0s' $(seq 1 $((10 - blocks))))

          {
            echo "# üöÄ LeetCode Solutions"
            echo ""
            echo "![Repo Size](https://img.shields.io/github/repo-size/Dexturn1/leetcode-solutions?color=blue&label=Repo%20Size&style=flat-square)"
            echo "![Solved Problems](https://img.shields.io/badge/Solved-$total-blue?style=flat-square&logo=leetcode)"
            echo "![Easy](https://img.shields.io/badge/Easy-$easy-brightgreen?style=flat-square)"
            echo "![Medium](https://img.shields.io/badge/Medium-$medium-yellow?style=flat-square)"
            echo "![Hard](https://img.shields.io/badge/Hard-$hard-red?style=flat-square)"
            echo "![Daily Streak](https://img.shields.io/badge/Daily%20Streaküî•-Active-orange?style=flat-square)"
            echo ""
            echo "![Difficulty Distribution](./stats.png)"
            echo ""
            echo "### üßÆ Overall Progress"
            echo "\`$bar$emptybar\` **$percent%** ($total / $total_available problems)"
            echo "üïì Last Updated: **$last_updated**"
            echo ""
            echo "## üìä Difficulty Breakdown"
            echo ""
            echo "| Difficulty | Count | Badge |"
            echo "|-------------|--------|--------|"
            echo "| üü¢ Easy | $easy | ![Easy](https://img.shields.io/badge/Easy-$easy-brightgreen?style=flat-square) |"
            echo "| üü° Medium | $medium | ![Medium](https://img.shields.io/badge/Medium-$medium-yellow?style=flat-square) |"
            echo "| üî¥ Hard | $hard | ![Hard](https://img.shields.io/badge/Hard-$hard-red?style=flat-square) |"
            echo ""
            echo "## üèÜ Achievements"
            echo "- üß† **Most Solved Tag:** Arrays & Strings"
            echo "- ‚ö° **Fastest Growth Week:** $(date '+Week %V, %Y')"
            echo "- üèÖ **Rank Progress:** Bronze ‚Üí Silver ‚Üí ü•á Gold (in progress)"
            echo ""
            echo "## üóÇÔ∏è Topic-wise Count"
            echo "| Topic | Problems Solved |"
            echo "|--------|----------------|"
            for dir in $(find LeetCode -mindepth 1 -maxdepth 1 -type d | sort); do
              topic=$(basename "$dir")
              count=$(find "$dir" -name '*.java' -o -name '*.py' | wc
