name: LeetCode Organizer Deluxe ‚ú®

on:
  push:
    branches: [ main ]
  pull_request:
  schedule:
    - cron: "0 0 * * *" # daily at midnight UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

env:
  REPO_OWNER: Dexturn1
  REPO_NAME: leetcode-solutions

jobs:
  organize:
    runs-on: ubuntu-latest

    steps:
      # Step 1 ‚Äî Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # Step 2 ‚Äî Cache pip dependencies
      - name: Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # Step 3 ‚Äî Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11.9"

      # Step 4 ‚Äî Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install matplotlib pillow requests

      # Step 5 ‚Äî Ensure directory structure
      - name: Ensure structure
        run: |
          mkdir -p LeetCode/{Easy,Medium,Hard}
          touch LeetCode/Easy/.gitkeep LeetCode/Medium/.gitkeep LeetCode/Hard/.gitkeep
          echo "‚úÖ Structure ready."

      # Step 6 ‚Äî Clean up empty folders
      - name: Cleanup empty folders
        run: |
          find LeetCode -mindepth 1 -type d -empty -exec rm -rf {} +

      # Step 7 ‚Äî Generate LeetCode stats (difficulty + languages)
      - name: Generate stats charts
        run: |
          python <<'PYCODE'
          import os, matplotlib.pyplot as plt, collections, datetime, json
          base = "LeetCode"
          langs = collections.Counter()
          diff = {"Easy":0, "Medium":0, "Hard":0}

          for root, _, files in os.walk(base):
              for f in files:
                  if f.endswith(".java"): langs["Java"] += 1
                  elif f.endswith(".py"): langs["Python"] += 1
                  if "Easy" in root: diff["Easy"] += 1
                  elif "Medium" in root: diff["Medium"] += 1
                  elif "Hard" in root: diff["Hard"] += 1

          if not sum(diff.values()):
              diff = {"Easy":1,"Medium":1,"Hard":1}
          os.makedirs("LeetCode", exist_ok=True)

          # Pie chart
          plt.figure(figsize=(5,5))
          plt.pie(diff.values(), labels=[f"{k} ({v})" for k,v in diff.items()],
                  colors=["#00C853","#FFD600","#D50000"], autopct="%1.1f%%")
          plt.title("Difficulty Distribution")
          plt.savefig("LeetCode/stats.png", bbox_inches="tight")

          # Language bar chart
          plt.figure(figsize=(4,3))
          plt.bar(langs.keys(), langs.values(), color="#64B5F6")
          plt.title("Language Usage")
          plt.ylabel("Files")
          plt.tight_layout()
          plt.savefig("LeetCode/langs.png")

          # Save totals for Gist sync
          data = {
              "total": sum(diff.values()),
              "easy": diff["Easy"],
              "medium": diff["Medium"],
              "hard": diff["Hard"],
              "langs": dict(langs),
              "last_update": datetime.datetime.utcnow().isoformat()
          }
          with open("LeetCode/stats.json","w") as f: json.dump(data,f)
          PYCODE

      # Step 8 ‚Äî Regenerate README.md
      - name: Regenerate README.md
        run: |
          total=$(find LeetCode -name '*.java' -o -name '*.py' | wc -l)
          easy=$(grep -r -l "Easy" LeetCode | wc -l || echo 0)
          medium=$(grep -r -l "Medium" LeetCode | wc -l || echo 0)
          hard=$(grep -r -l "Hard" LeetCode | wc -l || echo 0)
          langs=$(find LeetCode -type f \( -name "*.py" -o -name "*.java" \) | sed 's/.*\.//' | sort | uniq -c)
          last_updated=$(date '+%d %b %Y, %I:%M %p')

          contributors_list=$(git shortlog -sn --all | sort -nr)
          top_name=$(echo "$contributors_list" | head -n1 | awk '{$1="";print $0}' | sed 's/^ *//')
          top_user=$(echo "$top_name" | sed 's/ /%20/g')

          glow="<a href='https://github.com/${top_user}'><img src='https://github.com/${top_user}.png' width='60' height='60' style='border-radius:50%;box-shadow:0 0 15px #FFD700,0 0 30px #FFA500;animation:pulse 2s infinite' alt='${top_name}'/></a> **${top_name} ü•á**"

          contributors=$(echo "$contributors_list" | awk '{$1=""; print $0}' | sed 's/^ *//' | while read -r name; do
            username=$(echo "$name" | sed 's/ /%20/g')
            commits_url="https://github.com/${{ env.REPO_OWNER }}/${{ env.REPO_NAME }}/commits?author=$username"
            echo "<a href='$commits_url'><img src='https://github.com/$username.png' width='50' height='50' style='border-radius:50%;margin:4px' alt='$name'/></a>"
          done)

          {
            echo "# üöÄ LeetCode Solutions (Deluxe Edition)"
            echo ""
            echo "![Build](https://github.com/${{ env.REPO_OWNER }}/${{ env.REPO_NAME }}/actions/workflows/leetcode-deluxe.yml/badge.svg)"
            echo "![Contributors](https://img.shields.io/github/contributors/${{ env.REPO_OWNER }}/${{ env.REPO_NAME }}?color=purple)"
            echo "![Stars](https://img.shields.io/github/stars/${{ env.REPO_OWNER }}/${{ env.REPO_NAME }}?style=flat-square)"
            echo "![Forks](https://img.shields.io/github/forks/${{ env.REPO_OWNER }}/${{ env.REPO_NAME }}?style=flat-square)"
            echo "![Repo Size](https://img.shields.io/github/repo-size/${{ env.REPO_OWNER }}/${{ env.REPO_NAME }}?color=blue)"
            echo ""
            echo "![Difficulty Distribution](./LeetCode/stats.png)"
            echo "![Language Usage](./LeetCode/langs.png)"
            echo ""
            echo "### üßÆ Progress"
            echo "**Total:** $total problems"
            echo "üü¢ Easy: $easy ‚Ä¢ üü° Medium: $medium ‚Ä¢ üî¥ Hard: $hard"
            echo "üïì Last Updated: **$last_updated**"
            echo ""
            echo "## üß† Languages Used"
            echo "\`\`\`"
            echo "$langs"
            echo "\`\`\`"
            echo ""
            echo "## ü§ù Contributors"
            echo "<div align='center'>$contributors</div>"
            echo ""
            echo "### ü•á Top Contributor"
            echo "<div align='center'>$glow</div>"
            echo ""
            echo "---"
            echo "Generated automatically by GitHub Actions üöÄ"
          } > README.md

      # Step 9 ‚Äî Commit and push changes
      - name: Commit and push
        run: |
          git config user.name "LeetHub-Auto"
          git config user.email "actions@github.com"
          git add README.md LeetCode/*.png LeetCode/*.json || true
          git commit -m "Deluxe LeetCode automation update" || echo "No changes"
          git push

      # Step 10 ‚Äî Gist Sync (optional)
      - name: Update Gist
        if: env.GIST_TOKEN != ''
        run: |
          gist_id="YOUR_GIST_ID"
          curl -X PATCH \
            -H "Authorization: token ${{ secrets.GIST_TOKEN }}" \
            -d "{\"files\": {\"leetcode-stats.json\": {\"content\": \"$(cat LeetCode/stats.json)\"}}}" \
            https://api.github.com/gists/$gist_id

      # Step 11 ‚Äî Discord Notification on Failure
      - name: Notify failure
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
            -d "{\"content\": \"‚ùå Workflow failed in **${{ env.REPO_NAME }}**! Check: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID\"}" \
            ${{ secrets.DISCORD_WEBHOOK_URL }}

      # Step 12 ‚Äî Comment workflow summary
      - name: Comment summary
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = `‚úÖ Workflow succeeded!  
            **Solved Problems:** ${process.env.total}  
            üü¢ Easy: ${process.env.easy} | üü° Medium: ${process.env.medium} | üî¥ Hard: ${process.env.hard}`;
            github.rest.issues.createComment({
              issue_number: context.issue.number || 1,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
