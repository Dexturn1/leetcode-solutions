name: Fresh LeetCode Organizer

on:
  push:
    branches: [ main ]
  schedule:
    - cron: "0 0 * * *" # runs daily at midnight UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  organize:
    runs-on: ubuntu-latest

    steps:
      # Step 1 ‚Äî Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # Step 2 ‚Äî Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11.9"

      # Step 3 ‚Äî Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests matplotlib pillow

      # Step 4 ‚Äî Ensure structure and default files exist
      - name: Ensure base structure
        run: |
          mkdir -p LeetCode/Easy LeetCode/Medium LeetCode/Hard
          touch LeetCode/Easy/.gitkeep
          touch LeetCode/Medium/.gitkeep
          touch LeetCode/Hard/.gitkeep

          if [ ! -f README.md ]; then
            echo "# üöÄ LeetCode Solutions" > README.md
            echo "" >> README.md
            echo "![Build](https://github.com/Dexturn1/leetcode-solutions/actions/workflows/leetcode-fresh.yml/badge.svg)" >> README.md
            echo "![Last Commit](https://img.shields.io/github/last-commit/Dexturn1/leetcode-solutions)" >> README.md
            echo "![Python](https://img.shields.io/badge/Python-3.11-blue?logo=python)" >> README.md
            echo "" >> README.md
            echo "Welcome to my organized collection of LeetCode solutions." >> README.md
            echo "" >> README.md
            echo "## üìÅ Folder Structure" >> README.md
            echo "- üü¢ LeetCode/Easy" >> README.md
            echo "- üü° LeetCode/Medium" >> README.md
            echo "- üî¥ LeetCode/Hard" >> README.md
            echo "" >> README.md
            echo "Each folder contains problems grouped by difficulty." >> README.md
          fi

      # Step 5 ‚Äî Clean up empty topic folders
      - name: Clean up empty folders
        run: |
          echo "üßπ Cleaning up empty folders..."
          find LeetCode -mindepth 1 -type d ! -path "LeetCode/Easy" ! -path "LeetCode/Medium" ! -path "LeetCode/Hard" -empty -exec rm -rf {} +
          echo "‚úÖ Cleanup complete."

      # Step 6 ‚Äî Run sorter script
      - name: Run sorter script
        run: |
          python .github/scripts/sort_by_topic.py || echo "‚ö†Ô∏è Sort script completed with warnings but workflow continues."

      # Step 7 ‚Äî Generate difficulty chart
      - name: Generate LeetCode stats chart
        run: |
          python <<'PYCODE'
          import os
          import matplotlib.pyplot as plt

          base = "LeetCode"
          colors = {"Easy": "#00C853", "Medium": "#FFD600", "Hard": "#D50000"}
          counts = {"Easy": 0, "Medium": 0, "Hard": 0}

          for root, _, files in os.walk(base):
              for f in files:
                  if f.endswith((".java", ".py")):
                      if "Easy" in root:
                          counts["Easy"] += 1
                      elif "Medium" in root:
                          counts["Medium"] += 1
                      elif "Hard" in root:
                          counts["Hard"] += 1

          if sum(counts.values()) == 0:
              counts = {"Easy": 1, "Medium": 1, "Hard": 1}

          plt.figure(figsize=(6, 6))
          plt.pie(
              counts.values(),
              labels=[f"{k} ({v})" for k, v in counts.items()],
              colors=[colors[k] for k in counts],
              autopct="%1.1f%%",
              startangle=140,
              wedgeprops={"edgecolor": "white", "linewidth": 2},
          )
          plt.title("LeetCode Difficulty Distribution", fontsize=14, fontweight="bold")
          os.makedirs("LeetCode", exist_ok=True)
          plt.savefig("LeetCode/stats.png", bbox_inches="tight")
          PYCODE

      # Step 8 ‚Äî Generate dynamic README
      - name: Regenerate README.md
        run: |
          total=$(find LeetCode -name '*.java' -o -name '*.py' | wc -l)
          easy=$(grep -r -l "Easy" LeetCode | wc -l || echo 0)
          medium=$(grep -r -l "Medium" LeetCode | wc -l || echo 0)
          hard=$(grep -r -l "Hard" LeetCode | wc -l || echo 0)
          last_updated=$(date '+%d %b %Y, %I:%M %p')
          total_available=2800
          percent=$(( total * 100 / total_available ))
          [ $percent -lt 30 ] && color="red" || ([ $percent -lt 70 ] && color="yellow" || color="brightgreen")
          blocks=$(( percent / 10 ))
          bar=$(printf '‚ñà%.0s' $(seq 1 $blocks))
          emptybar=$(printf '‚ñë%.0s' $(seq 1 $((10 - blocks))))

          contributors=$(git shortlog -sn --all | awk '{$1=""; print $0}' | sort | uniq | sed 's/^ *//' | while read -r name; do
            user=$(echo "$name" | sed 's/ /%20/g')
            echo "<a href='https://github.com/$name'><img src='https://github.com/$name.png' width='50' height='50' style='border-radius:50%;margin:4px' alt='$name'/></a>"
          done)

          {
            echo "# üöÄ LeetCode Solutions"
            echo ""
            echo "![Build](https://github.com/Dexturn1/leetcode-solutions/actions/workflows/leetcode-fresh.yml/badge.svg)"
            echo "![Last Commit](https://img.shields.io/github/last-commit/Dexturn1/leetcode-solutions)"
            echo "![Python](https://img.shields.io/badge/Python-3.11-blue?logo=python)"
            echo ""
            echo "![Repo Size](https://img.shields.io/github/repo-size/Dexturn1/leetcode-solutions?color=blue&label=Repo%20Size&style=flat-square)"
            echo "![Solved Problems](https://img.shields.io/badge/Solved-$total-blue?style=flat-square&logo=leetcode)"
            echo "![Easy](https://img.shields.io/badge/Easy-$easy-brightgreen?style=flat-square)"
            echo "![Medium](https://img.shields.io/badge/Medium-$medium-yellow?style=flat-square)"
            echo "![Hard](https://img.shields.io/badge/Hard-$hard-red?style=flat-square)"
            echo ""
            echo "![Difficulty Distribution](./LeetCode/stats.png)"
            echo ""
            echo "### üßÆ Overall Progress"
            echo "\`$bar$emptybar\` **$percent%** ($total / $total_available problems)"
            echo "üïì Last Updated: **$last_updated**"
            echo ""
            echo "## üìä Difficulty Breakdown"
            echo "| Difficulty | Count |"
            echo "|-------------|--------|"
            echo "| üü¢ Easy | $easy |"
            echo "| üü° Medium | $medium |"
            echo "| üî¥ Hard | $hard |"
            echo ""
            echo "## üèÜ Achievements"
            echo "- üß† **Most Solved Tag:** Arrays & Strings"
            echo "- ‚ö° **Fastest Growth Week:** $(date '+Week %V, %Y')"
            echo "- üèÖ **Rank Progress:** Bronze ‚Üí Silver ‚Üí ü•á Gold (in progress)"
            echo ""
            echo "## üóÇÔ∏è Topic-wise Count"
            echo "| Topic | Problems Solved |"
            echo "|--------|----------------|"
            for dir in $(find LeetCode -mindepth 1 -maxdepth 1 -type d | sort); do
              topic=$(basename "$dir")
              count=$(find "$dir" -name '*.java' -o -name '*.py' | wc -l)
              echo "| $topic | $count |"
            done
            echo ""
            echo "## ü§ù Contributors"
            echo "<div align='center'>$contributors</div>"
            echo ""
            echo "---"
            echo "Generated automatically by GitHub Actions üöÄ"
          } > README.md

      # Step 9 ‚Äî Commit and push changes
      - name: Commit and push changes
        run: |
          git config user.name "LeetHub-Auto"
          git config user.email "actions@github.com"
          git add README.md LeetCode/stats.png LeetCode/**/.gitkeep || true
          git commit -m "Auto-organized LeetCode problems and updated README" || echo "No changes to commit"
          git push
